# Распределенные транзакции
## Проблемы ACID
Проблемы ACID - принципы транзакционности
- A - Атомарность (либо все либо ничего)
- С - Consistency (согласованность - инвариант - который может выполняться и до транзакции и после)
- I - Изолированность
- D - Durability (надежность - долговечность - возможность прочитать данные после сбоя)

**Dirty reads** - Грязное чтение  
Когда читаются данные, которые в этот момент изменяются транзакцией, а потом транзакция откатывается и данные исчезают.  
  
**Dirty writes** - Грязная запись  
Когда записывается то что не может быть записано. Пример из реальной жизни - это например когда продавец на принял оплату и выписал акты на получение на 2 товара - а на складе их 1-н.  
В супермаркетах - момент когда ты кладешь товар с полки в корзину - как раз таки является аналогом блокировки которая спасает от подобных проблем. Вообщем - кто первый того и тапки.  
  
**Unrepeatable Reads** Неповторяющееся чтение  
Когда несколько раз читаются данные, которые в этот момент изменяются транзакцией — каждый раз данные могут отказаться другими.  
  
**Потерянное обновление**  
Когда две транзакции записывают разные значения в одну и ту же ячейку, одно из изменений теряется.  

**Фантомное чтение**  
Одна транзакция в ходе своего выполнения несколько раз выбирает множество строк по одним и тем же критериям. Другая транзакция в интервалах между этими выборками добавляет или удаляет строки или изменяет столбцы некоторых строк, используемых в критериях выборки первой транзакции, и успешно заканчивается. В результате получится, что одни и те же выборки в первой транзакции дают разные множества строк.  
  
_То что написанно выше - оч трудно в понимании - нужно читать доп литературу_

## Типы согласованности
![Типы согласованности](images/08-distributed%20transactions/linerizability.jpeg)

- **String consistency** (сильная согласованность) - после завершения обновления данных все последующие чтения вернут новые данные.
- **Monotonic read/write consistency** - процесс не может получить старое значение после нового/записать значения не в том порядке.
- **Weak consistency** (слаба согласованность) - есть окно несогласованности.
    - **Eventual consistency** (согласованность в конечном счете) - размер окна несогласованности не фиксирован, зависит от внешних условий.  
        - **Causal consistency** (причинная согласованность) - только процессы, уведомленные об обновлениях гарантированно прочитают новые данные.
            - **Read-your-writes-consistency** - только сам процесс гарантированно читает обновленные им самим данные
                - **Session consistency** - процесс получает доступ к хранилищу в рамках сессии

## CAP теорема
![CAP теорема](images/08-distributed%20transactions/CAP.png)

### Как жить с несогласованностью
- Оптимистичная согласованность
- Объединение сервисов
- Двухфазные коммиты (2PC)
- Паттерн Saga 

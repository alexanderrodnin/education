# Распределенные транзакции
## Проблемы ACID
Проблемы ACID - принципы транзакционности
- A - Атомарность (либо все либо ничего)
- С - Consistency (согласованность - инвариант - который может выполняться и до транзакции и после)
- I - Изолированность
- D - Durability (надежность - долговечность - возможность прочитать данные после сбоя)

**Dirty reads** - Грязное чтение  
Когда читаются данные, которые в этот момент изменяются транзакцией, а потом транзакция откатывается и данные исчезают.  
  
**Dirty writes** - Грязная запись  
Когда записывается то что не может быть записано. Пример из реальной жизни - это например когда продавец на принял оплату и выписал акты на получение на 2 товара - а на складе их 1-н.  
В супермаркетах - момент когда ты кладешь товар с полки в корзину - как раз таки является аналогом блокировки которая спасает от подобных проблем. Вообщем - кто первый того и тапки.  
  
**Unrepeatable Reads** Неповторяющееся чтение  
Когда несколько раз читаются данные, которые в этот момент изменяются транзакцией — каждый раз данные могут отказаться другими.  
  
**Потерянное обновление**  
Когда две транзакции записывают разные значения в одну и ту же ячейку, одно из изменений теряется.  

**Фантомное чтение**  
Одна транзакция в ходе своего выполнения несколько раз выбирает множество строк по одним и тем же критериям. Другая транзакция в интервалах между этими выборками добавляет или удаляет строки или изменяет столбцы некоторых строк, используемых в критериях выборки первой транзакции, и успешно заканчивается. В результате получится, что одни и те же выборки в первой транзакции дают разные множества строк.  
  
_То что написанно выше - оч трудно в понимании - нужно читать доп литературу_

## Типы согласованности
![Типы согласованности](images/08-distributed%20transactions/linerizability.jpeg)

- **String consistency** (сильная согласованность) - после завершения обновления данных все последующие чтения вернут новые данные.
- **Monotonic read/write consistency** - процесс не может получить старое значение после нового/записать значения не в том порядке.
- **Weak consistency** (слаба согласованность) - есть окно несогласованности.
    - **Eventual consistency** (согласованность в конечном счете) - размер окна несогласованности не фиксирован, зависит от внешних условий.  
        - **Causal consistency** (причинная согласованность) - только процессы, уведомленные об обновлениях гарантированно прочитают новые данные.
            - **Read-your-writes-consistency** - только сам процесс гарантированно читает обновленные им самим данные
                - **Session consistency** - процесс получает доступ к хранилищу в рамках сессии

## CAP теорема
![CAP теорема](images/08-distributed%20transactions/CAP.png)

### Как жить с несогласованностью
- Оптимистичная согласованность
- Объединение сервисов
- Двухфазные коммиты (2PC)
- Паттерн Saga 

### Оптимистичная согласованность
Просто используем локальные транзакции и надеемся на лучшее
- Если всё плохо здесь и сейчас
    - Утверждаем, что в конечном счёте всё будет хорошо
- Если в конечном счёте всё плохо
    - Подобное неизбежно случается, но вероятность этого мала и
потери незначительны

### Объединение сервисов
Просто проводим границы сервисов по транзакциям

### Двухфазные коммиты (2PC)
[google it](https://www.google.com/search?q=%D0%B4%D0%B2%D1%83%D1%85%D1%84%D0%B0%D0%B7%D0%BD%D1%8B%D0%B9+%D0%BA%D0%BE%D0%BC%D0%BC%D0%B8%D1%82&newwindow=1&sxsrf=ALeKk00UQ3hivTIb3tJNiYhgiwDi7xNSww%3A1629188012417&ei=rG8bYYXuGIOMxc8P8daIgAs&oq=%D0%B4%D0%B2%D1%83%D1%85%D1%84%D0%B0%D0%B7%D0%BD%D1%8B%D0%B9+%D0%BA%D0%BE%D0%BC%D0%BC%D0%B8%D1%82&gs_lcp=Cgdnd3Mtd2l6EAMyBAgjECcyBAgjECcyBAgAEEMyBQgAEIAEMgYIABAWEB4yBggAEBYQHjoHCAAQRxCwA0oECEEYAFCnWFinWGDGXmgCcAJ4AIABbYgB0wGSAQMwLjKYAQCgAQHIAQjAAQE&sclient=gws-wiz&ved=0ahUKEwiF9IGmzrfyAhUDRvEDHXErArAQ4dUDCA4&uact=5)
### Паттерн Saga 
[github microservices saga pattern](microservices-saga-pattern)



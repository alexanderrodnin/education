# DDL - Data Definition Language

## Создание базы данных
```text
CREATE DATABASE имя
  [ [ WITH ] [ OWNER [=] имя_пользователя ]
    [ TEMPLATE [=] шаблон ]
    [ ENCODING [=] кодировка ]
    [ LC_COLLATE [=] категория_сортировки ]
    [ LC_CTYPE [=] категория_типов_символов ]
    [ TABLESPACE [=] табличное пространство_пространство ]
    [ ALLOW_CONNECTIONS [=] разр_подключения ] [ CONNECTION LIMIT [=] предел_подключений ]
    [ IS_TEMPLATE [=] это_шаблон ] ]
```

**Табличное пространство** - позволяют организовать логику размещения файлов объектов базы данных в файловой системе.  
По умолчанию создаются:  
- **pg_default** - используется по умолчанию для баз данных template1 и template0.
- **pg_global** - используется для общих системных каталогов.
- **pg_tblspc** - содержит ссылки на новые табличные пространства.

**Создание табличного пространства**
```
CREATE TABLESPACE табл_пространство
    [ OWNER { новый_владелец | CURRENT_USER | SESSION_USER } ]
    LOCATION 'каталог'
```
**Замечания:**
- табличные пространства используются только на платформах, поддерживающих символические ссылки;
- команда не может быть выполнена внутри блока транзакции.

## Создание ролей
``` 
CREATE ROLE имя [ [ WITH ] параметр [ ... ] ]
```
CREATE ROLE добавляет новую роль в кластер баз данных PostgreSQL. 
Роль — это сущность, которая может владеть объектами и иметь определённые права в базе; 
роль может представлять «пользователя», «группу» или и то, и другое, в зависимости от варианта использования.  
  
[Official Ref](https://postgrespro.ru/docs/postgresql/9.6/sql-createrole)

## Создание пользователя
```
CREATE USER имя [ [ WITH ] параметр [ ... ] ]
```
Команда CREATE USER теперь является просто синонимом CREATE ROLE. Единственное отличие в том, что для команды, 
записанной в виде CREATE USER, по умолчанию подразумевается LOGIN, а в виде CREATE ROLE подразумевается NOLOGIN.

[Official Ref](https://postgrespro.ru/docs/postgresql/9.5/sql-createuser)

## Доп команды
- ```ALTER ROLE``` - изменение роли
- ```GRANT [GROUP] TO [USER]```

## Создание схемы
```text
CREATE SCHEMA имя_схемы [ AUTHORIZATION указание_роли ] [ элемент_схемы [ ... ] ]
CREATE SCHEMA AUTHORIZATION указание_роли [ элемент_схемы [ ... ] ]
CREATE SCHEMA IF NOT EXISTS имя_схемы [ AUTHORIZATION указание_роли ]
CREATE SCHEMA IF NOT EXISTS AUTHORIZATION указание_роли

Здесь указание_роли:

    имя_пользователя
  | CURRENT_USER
  | SESSION_USER
```

CREATE SCHEMA создаёт новую схему в текущей базе данных. Имя схемы должно отличаться от имён других существующих схем в текущей базе данных.
Схема по сути представляет собой пространство имён: она содержит именованные объекты (таблицы, типы данных, функции и операторы), 
имена которых могут совпадать с именами других объектов, существующих в других схемах. Для обращения к объекту нужно либо 
«дополнить» его имя именем схемы в виде префикса, либо установить путь поиска, включающий требуемую схему. Команда CREATE, 
в которой указывается неполное имя объекта, создаёт объект в текущей схеме (схеме, стоящей первой в пути поиска; узнать 
её позволяет функция current_schema).
Команда CREATE SCHEMA может дополнительно включать подкоманды, создающие объекты в новой схеме. Эти подкоманды по сути воспринимаются 
как отдельные команды, выполняемые после создания схемы, за исключением того, что с предложением AUTHORIZATION все создаваемые 
объекты будут принадлежать указанному в нём пользователю.  


[Official Ref](https://postgrespro.ru/docs/postgresql/9.5/sql-createschema)

## Создание таблицы
```
CREATE [ [ GLOBAL | LOCAL ] { TEMPORARY | TEMP } | UNLOGGED ] TABLE [ IF NOT EXISTS ] имя_таблицы ( [
  { имя_столбца тип_данных [ COLLATE правило_сортировки ] [ ограничение_столбца [ ... ] ]
    | ограничение_таблицы
    | LIKE исходная_таблица [ вариант_копирования ... ] }
    [, ... ]
] )
[ INHERITS ( таблица_родитель [, ... ] ) ]
[ WITH ( параметр_хранения [= значение] [, ... ] ) | WITH OIDS | WITHOUT OIDS ]
[ ON COMMIT { PRESERVE ROWS | DELETE ROWS | DROP } ]
[ TABLESPACE табл_пространство ]

CREATE [ [ GLOBAL | LOCAL ] { TEMPORARY | TEMP } | UNLOGGED ] TABLE [ IF NOT EXISTS ] имя_таблицы
    OF имя_типа [ (
  { имя_столбца WITH OPTIONS [ ограничение_столбца [ ... ] ]
    | ограничение_таблицы }
    [, ... ]
) ]
[ WITH ( параметр_хранения [= значение] [, ... ] ) | WITH OIDS | WITHOUT OIDS ]
[ ON COMMIT { PRESERVE ROWS | DELETE ROWS | DROP } ]
[ TABLESPACE табл_пространство ]

Здесь ограничение_столбца:

[ CONSTRAINT имя_ограничения ]
{ NOT NULL |
  NULL |
  CHECK ( выражение ) [ NO INHERIT ] |
  DEFAULT выражение_по_умолчанию |
  UNIQUE параметры_индекса |
  PRIMARY KEY параметры_индекса |
  REFERENCES целевая_таблица [ ( целевой_столбец ) ] [ MATCH FULL | MATCH PARTIAL | MATCH SIMPLE ]
    [ ON DELETE действие ] [ ON UPDATE действие ] }
[ DEFERRABLE | NOT DEFERRABLE ] [ INITIALLY DEFERRED | INITIALLY IMMEDIATE ]

и ограничение_таблицы:

[ CONSTRAINT имя_ограничения ]
{ CHECK ( выражение ) [ NO INHERIT ] |
  UNIQUE ( имя_столбца [, ... ] ) параметры_индекса |
  PRIMARY KEY ( имя_столбца [, ... ] ) параметры_индекса |
  EXCLUDE [ USING индексный_метод ] ( элемент_исключения WITH оператор [, ... ] ) параметры_индекса [ WHERE ( предикат ) ] |
  FOREIGN KEY ( имя_столбца [, ... ] ) REFERENCES целевая_таблица [ ( целевой_столбец [, ... ] ) ]
    [ MATCH FULL | MATCH PARTIAL | MATCH SIMPLE ] [ ON DELETE действие ] [ ON UPDATE действие ] }
[ DEFERRABLE | NOT DEFERRABLE ] [ INITIALLY DEFERRED | INITIALLY IMMEDIATE ]

и вариант_копирования:

{ INCLUDING | EXCLUDING } { DEFAULTS | CONSTRAINTS | INDEXES | STORAGE | COMMENTS | ALL }

параметры_индекса в ограничениях UNIQUE, PRIMARY KEY и EXCLUDE:

[ WITH ( параметр_хранения [= значение] [, ... ] ) ]
[ USING INDEX TABLESPACE табл_пространство ]

элемент_исключения в ограничении EXCLUDE:

{ имя_столбца | ( выражение ) } [ класс_операторов ] [ ASC | DESC ] [ NULLS { FIRST | LAST } ]
```

[Official Ref](https://postgrespro.ru/docs/postgresql/9.5/sql-createtable)

## Сенкционирование таблиц
1. Для вставки записи триггеры не нужны:
   - автоматическое перенаправление вставляемых данных в правильную секцию.
   - генерируется ошибка в случае направления в неподходящую секцию.
2. При работе с секциями:
   - можно присоединять/отсоединять секции.
   - есть явные ограничения целостности секций.
   - возможно секционирование по выражению в ключе разбиения.
   - можно создавать подсекции.
3. Изменения в системном каталоге:
   - новые столбцы в pg_class.
   - новый каталог pg_partitioned_table.

### Виды секционирования
- по списку
- по диапазону
- по хешу
- по выражению
- по составному ключу 
- с подсекциями

**Примеры**
```
1. по списку
CREATE TABLE имя1(поле1 integer, поле2 text) PARTITION BY LIST (поле1);
CREATE TABLE имя1_a PARTITION OF имя1 FOR VALUES IN (1, 2, 3); ...

2. по диапазону
CREATE TABLE имя2(поле1 integer, поле2 text) PARTITION BY RANGE (поле1); 
CREATE TABLE имя2_а PARTITION OF имя2 FOR VALUES FROM (1) to (100);

3. по составному ключу
CREATE TABLE имя3(поле1 integer, поле2 date) PARTITION BY RANGE (поле1, поле2);
CREATE TABLE имя3_а PARTITION OF имя3 FOR VALUES FROM (знач_1 поля1, знач_1 поля2) to (знач_N поля1, знач_N поля2);
```

### Ограничения секционирования

1. Родительская таблица не может содержать данных.
2. В секциях не может быть дополнительных относительно родительской таблицы столбцов.
3. Множественное наследование не допускается.
4. Значения NULL в секциях допускаются только в том случае, если они допускаются в родительской таблице.
5. Секции, не принадлежащие данному экземпляру СУБД, не поддерживаются (но можно присоединять секцию как FDW — CREATE FOREIGN TABLE ... PARTITION OF ...).

### Foreign table
CREATE FOREIGN TABLE создаёт новую стороннюю таблицу в текущей базе данных. Владельцем таблицы будет пользователь, выполнивший эту команду.  
CREATE FOREIGN DATA WRAPPER — создать новую обёртку сторонних данных

## Sequence
```
CREATE [ TEMPORARY | TEMP ] SEQUENCE [ IF NOT EXISTS ] имя
[ AS тип_данных ]
[ INCREMENT [ BY ] шаг ]
[ MINVALUE мин_значение | NO MINVALUE ] [ MAXVALUE макс_значение | NO MAXVALUE ]
[ START [ WITH ] начало ] [ CACHE кеш ] [ [ NO ] CYCLE ]
[ OWNED BY { имя_таблицы.имя_столбца | NONE } ]
```

## Views
View - постоянно находится в памяти и пересчитывается автоматически.  
Mat View - сохраняется на диске, пересчитывается при вызове команды.


##  TRUNCATE - удаление записей
```text
TRUNCATE [ TABLE ] [ ONLY ] имя [ * ] [, ... ]
  [ RESTART IDENTITY | CONTINUE IDENTITY ]
  [ CASCADE | RESTRICT ]
```
- RESTART IDENTITY - автоматически перезапускать последовательности, связанные со столбцами таблицы.
- CONTINUE IDENTITY (по умолчанию) не изменять значения последовательностей.
- CASCADE - автоматическое удаление записей всех таблиц, ссылающихся по внешнему ключу на указанные в команде таблицы.
- RESTRICT (по умолчанию) - запрет на удаление записей из таблиц, имеющих ссылки на таблицы, не перечисленные в команде.

**Особенности:**
- Для удаления записей надо иметь право TRUNCATE для этой таблицы.
- После удаления строк таблицы, сразу освобождается дисковое пространство, поэтому выполнять операцию VACUUM не требуется.
- Если таблица, содержит ссылки на другие таблицы, то записи в них также должны быть удалены этой же командой.
- Команда не поддерживается для сторонних таблиц.

| View                                                                                        | Materialized view                                         |
|---------------------------------------------------------------------------------------------|-----------------------------------------------------------|
| Никогда не сохраняется, а только отображается                                               | Хранится на диске                                         |
| Виртуальная таблица сформированная из одной или нескольких базовых таблиц или представлений | Является физической копией базовой таблицы                |
| Обновляется каждый раз, когда используется                                                  | Должно обновляться вручную или с использованием триггеров |
| Медленная обработка                                                                         | Быстрая обработка                                         |
| Не требует места в памяти                                                                   | Использует пространство в памяти                          |


## Links
[Команды SQL Postgres](https://postgrespro.ru/docs/postgresql/13/sql-commands)
